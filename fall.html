<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>iPhone 横屏 Plinko</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        body {
            margin: 0;
            background: #f0f0f0;
            overflow: hidden;
        }

        canvas {
            display: block;
        }

        #controls {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        #controls input {
            width: 50px;
        }
    </style>
</head>
<body>
<div id="result" style="position:absolute;top:50px;left:50%;transform:translateX(-50%);font-size:20px;color:red;"></div>

<div id="controls">
    <label>控制落点数字: <input id="targetNum" type="number" value="2"></label>
    <button id="dropBall">掉落小球</button>
</div>
<script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>
<script>


    const {Engine, Render, Runner, Bodies, Composite, Events, Body} = Matter;

    // -------------------- 初始化 --------------------
    const engine = Engine.create();
    const world = engine.world;

    // 横屏自适应
    let width = window.innerWidth;
    let height = window.innerHeight;

    window.addEventListener('resize', () => {
        width = window.innerWidth;
        height = window.innerHeight;
        render.canvas.width = width;
        render.canvas.height = height;
    });

    const render = Render.create({
        element: document.body,
        engine,
        options: {width, height, wireframes: false, background: '#fff'}
    });
    Render.run(render);
    Runner.run(Runner.create(), engine);

    // 边界
    const wallThickness = 20;
    Composite.add(world, [
        Bodies.rectangle(width / 2, -wallThickness / 2, width, wallThickness, {isStatic: true}),
        Bodies.rectangle(width / 2, height + wallThickness / 2, width, wallThickness, {isStatic: true}),
        Bodies.rectangle(-wallThickness / 2, height / 2, wallThickness, height, {isStatic: true}),
        Bodies.rectangle(width + wallThickness / 2, height / 2, wallThickness, height, {isStatic: true})
    ]);

    // -------------------- 底部格子 --------------------
    const slotsArr = [1, 3, 2, 1, 5, 6, 5, 1, 4, 3, 2, 1];
    const slotCount = slotsArr.length;
    const slotWidth = width / slotCount;
    const slotHeight = height * 0.18; // 占屏幕高度比例

    for (let i = 0; i < slotCount; i++) {
        const leftX = i * slotWidth;
        const rightX = (i + 1) * slotWidth;
        const yTop = height - slotHeight;
        const yBottom = height;
        // 左边
        Composite.add(world, Bodies.rectangle(leftX, yTop + slotHeight / 2, 2, slotHeight, {
            isStatic: true,
            render: {fillStyle: '#000'}
        }));
        // 右边
        Composite.add(world, Bodies.rectangle(rightX, yTop + slotHeight / 2, 2, slotHeight, {
            isStatic: true,
            render: {fillStyle: '#000'}
        }));
        // 底部
        Composite.add(world, Bodies.rectangle(leftX + slotWidth / 2, yBottom, slotWidth, 2, {
            isStatic: true,
            render: {fillStyle: '#000'}
        }));
    }

    // Canvas绘制数字在格子内
    const canvas = render.canvas;
    const ctx = canvas.getContext('2d');
    (function drawSlotNumbers() {
        ctx.clearRect(0, 0, width, height);
        Render.world(render);
        ctx.fillStyle = '#000';
        ctx.font = `${Math.floor(slotHeight / 2)}px Arial`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        for (let i = 0; i < slotCount; i++) {
            const x = i * slotWidth + slotWidth / 2;
            const y = height - slotHeight / 2;
            ctx.fillText(slotsArr[i], x, y);
        }
        requestAnimationFrame(drawSlotNumbers);
    })();

    // -------------------- 三角形柱子网格 --------------------
    const rows = 7;   // 行数
    const cols = 18;   // 列数（偶数行柱子数）
    const spacingX = width / cols;
    const spacingY = (height - slotHeight - 100) / rows; // 留出底部格子高度
    const radius = 6;

    for (let row = 0; row < rows; row++) {
        const isOdd = row % 2 !== 0;
        const offsetX = isOdd ? spacingX / 2 : 0; // 奇数行偏移
        const colCount = isOdd ? cols - 1 : cols; // 偶数行完整列，奇数行少一列
        for (let col = 0; col < colCount; col++) {
            const x = col * spacingX + offsetX + spacingX / 2;
            const y = row * spacingY + 100;
            Composite.add(world, Bodies.circle(x, y, radius, {
                isStatic: true,
                render: {fillStyle: '#333'}
            }));
        }
    }

    // -------------------- 小球生成 --------------------
    const balls = [];

    function dropBall(targetNum) {
        const targetIndexes = [];
        slotsArr.forEach((v, i) => {
            if (v === targetNum) targetIndexes.push(i);
        });
        if (targetIndexes.length === 0) return;

        const chosenIndex = targetIndexes[Math.floor(Math.random() * targetIndexes.length)];
        const targetX = chosenIndex * slotWidth + slotWidth / 2;

        // 从目标格子附近随机偏移投下，而不是正上方
        const offsetRange = slotWidth * 0.5; // ±50%格子宽度
        const startX = targetX + (0.5 - Math.random()) *5* offsetRange;
        const ball = Bodies.circle(startX, 50, 10, {
            restitution: 0.6,
            friction: 0.85,
            frictionAir: 0.045,
            render: {fillStyle: '#f00'}
        });
        ball.targetX = targetX;
        balls.push(ball);
        Composite.add(world, ball);
    }


    // -------------------- 小球微力引导 --------------------
    Events.on(engine, 'afterUpdate', function () {
        for (let i = balls.length - 1; i >= 0; i--) {
            const ball = balls[i];
            if (ball.position.y < height - 100) {
                const dx = ball.targetX - ball.position.x;
                Body.applyForce(ball, ball.position, {x: dx * 0.000002, y: 0});
            }
            if (ball.position.y > height - 15) {
                const index = Math.floor(ball.position.x / slotWidth);
                document.getElementById('result').innerText = `小球落在数字: ${slotsArr[index]} (格子${index})`;
                Composite.remove(world, ball);
                balls.splice(i, 1);
            }
        }
    });

    // -------------------- 控件 --------------------
    document.getElementById('dropBall').addEventListener('click', () => {
        const targetNum = parseInt(document.getElementById('targetNum').value);
        dropBall(targetNum);
    });


</script>
</body>
</html>
