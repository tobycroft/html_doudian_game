<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>增强版可控Plinko</title>
    <style>
        body { margin: 0; background: #f0f0f0; display: flex; justify-content: center; align-items: flex-start; height: 100vh; }
        canvas { border: 2px solid #333; background: #fff; display: block; }
        #controls { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); }
    </style>
</head>
<body>
<div id="controls">
    <label>控制落点数字: <input id="targetNum" type="number" value="2"></label>
    <button id="dropBall">掉落小球</button>
</div>
<script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>
<script>
    const { Engine, Render, Runner, Bodies, Composite, Events, Body } = Matter;

    // -------------------- 初始化 --------------------
    const engine = Engine.create();
    const world = engine.world;
    const width = 500, height = 600;
    const render = Render.create({
        element: document.body,
        engine,
        options: { width, height, wireframes: false, background: '#fff' }
    });
    Render.run(render);
    Runner.run(Runner.create(), engine);

    // 边界
    const wallThickness = 20;
    Composite.add(world, [
        Bodies.rectangle(width/2, -wallThickness/2, width, wallThickness, { isStatic: true }),
        Bodies.rectangle(width/2, height + wallThickness/2, width, wallThickness, { isStatic: true }),
        Bodies.rectangle(-wallThickness/2, height/2, wallThickness, height, { isStatic: true }),
        Bodies.rectangle(width + wallThickness/2, height/2, wallThickness, height, { isStatic: true })
    ]);

    // -------------------- 底部格子 --------------------
    const slotsArr = [1,3,2,1,5,6,5,1,4,3,2,1];
    const slotCount = slotsArr.length;
    const slotWidth = width / slotCount;
    const slotHeight = 50;

    // 绘制格子框
    for(let i=0;i<slotCount;i++){
        const x = i*slotWidth + slotWidth/2;
        const y = height - slotHeight/2;
        Composite.add(world, Bodies.rectangle(x, y, slotWidth, slotHeight, {
            isStatic: true,
            render: { fillStyle:'#fff', lineWidth:1, strokeStyle:'#000' }
        }));
    }

    // Canvas绘制格子内数字
    const canvas = render.canvas;
    const ctx = canvas.getContext('2d');
    (function drawSlotNumbers(){
        ctx.clearRect(0,0,width,height);
        Render.world(render);
        ctx.fillStyle = '#000';
        ctx.font = '20px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        for(let i=0;i<slotCount;i++){
            const x = i*slotWidth + slotWidth/2;
            const y = height - slotHeight/2;
            ctx.fillText(slotsArr[i], x, y);
        }
        requestAnimationFrame(drawSlotNumbers);
    })();

    // -------------------- 增加柱子密度 --------------------
    const rows = 15;  // 增加行数
    const cols = 12;  // 增加列数
    const spacingX = width / cols;
    const spacingY = (height - 150) / rows;
    for(let row=0; row<rows; row++){
        for(let col=0; col<cols; col++){
            const offset = row % 2 === 0 ? spacingX/2 : 0;
            const x = col*spacingX + offset + spacingX/2;
            const y = row*spacingY + 100;
            Composite.add(world, Bodies.circle(x, y, 5, {
                isStatic: true,
                render: { fillStyle: '#333' }
            }));
        }
    }

    // -------------------- 小球生成 --------------------
    const balls = [];
    function dropBall(targetNum){
        const targetIndexes = [];
        slotsArr.forEach((v,i)=>{ if(v===targetNum) targetIndexes.push(i); });
        if(targetIndexes.length === 0) return;

        const chosenIndex = targetIndexes[Math.floor(Math.random()*targetIndexes.length)];
        const minX = chosenIndex*slotWidth + 10;
        const maxX = (chosenIndex+1)*slotWidth - 10;
        const startX = Math.random()*(maxX - minX) + minX;

        const ball = Bodies.circle(startX, 50, 10, { restitution: 0.5, render: { fillStyle: '#f00' } });
        ball.targetX = chosenIndex*slotWidth + slotWidth/2;  // 微力引导目标
        balls.push(ball);
        Composite.add(world, ball);
    }

    // -------------------- 小球微力控制 --------------------
    Events.on(engine, 'afterUpdate', function() {
        for(let i=balls.length-1;i>=0;i--){
            const ball = balls[i];
            // 微力引导，但非常轻微
            if(ball.position.y < height - 100){
                const dx = ball.targetX - ball.position.x;
                Body.applyForce(ball, ball.position, { x: dx*0.00003, y:0 });
            }
            // 检测落地
            if(ball.position.y > height - slotHeight/2){
                const index = Math.floor(ball.position.x / slotWidth);
                alert(`小球落在数字: ${slotsArr[index]} (格子${index})`);
                Composite.remove(world, ball);
                balls.splice(i,1);
            }
        }
    });

    // -------------------- 控件 --------------------
    document.getElementById('dropBall').addEventListener('click', ()=>{
        const targetNum = parseInt(document.getElementById('targetNum').value);
        dropBall(targetNum);
    });
</script>
</body>
</html>
