<div id="progress-container" style="width: 80%; max-width: 24rem; margin: 2rem 0; background: #eee; border-radius: 1rem; overflow: hidden; height: 2rem;">
    <div id="progress-bar" style="width: 0%; height: 100%; background: #2563eb; transition: width 0s;"></div>
</div>
<script>
    (function(){
        const progressBar = document.getElementById('progress-bar');
        const spinBtn = document.getElementById('spinBtn');
        const counterEl = document.getElementById('counter');
        const resultModal = document.getElementById('resultModal');
        const bigNumEl = document.getElementById('bigNum');
        const okBtn = document.getElementById('okBtn');
        const numInput = document.getElementById('numSegmentsInput');

        let numSegments = Math.max(2, parseInt(numInput.value)||6);
        let spinCount = 0;
        let spinning = false;
        let lastResult = null;
        let progressStartTime = null;
        let progressDuration = 3000; // 基础读条时长
        let animationFrameId = null;

        function updateProgress(timestamp){
            if(!progressStartTime) progressStartTime = timestamp;
            const elapsed = timestamp - progressStartTime;
            let percent = Math.min(100, (elapsed / progressDuration) * 100);
            progressBar.style.width = percent + '%';
            if(percent < 100){
                animationFrameId = requestAnimationFrame(updateProgress);
            }else{
                spinning = false;
                // 随机结果
                numSegments = Math.max(2, Math.min(60, parseInt(numInput.value)||6));
                const result = Math.floor(Math.random() * numSegments) + 1;
                lastResult = result;
                setTimeout(()=>showResult(result), 300); // 0.3秒后弹窗
            }
        }

        function spin(){
            spinCount++;
            counterEl.textContent = `点击次数: ${spinCount}`;

            if(!spinning){
                spinning = true;
                progressBar.style.transition = 'none';
                progressBar.style.width = '0%';
                progressStartTime = null;
                animationFrameId = requestAnimationFrame(updateProgress);
            }else{
                // 加速：剩余时间缩短一半
                const computedStyle = window.getComputedStyle(progressBar);
                const currentWidth = parseFloat(computedStyle.width) / parseFloat(progressBar.parentElement.offsetWidth) * 100;
                cancelAnimationFrame(animationFrameId);
                progressDuration = Math.max(300, progressDuration * (1 - currentWidth/100)/2); // 剩余时间缩短
                progressStartTime = null;
                animationFrameId = requestAnimationFrame(updateProgress);
            }
        }

        function showResult(num){
            bigNumEl.textContent = num;
            resultModal.style.display = 'flex';
        }
        function closeResult(){
            resultModal.style.display = 'none';
        }

        spinBtn.addEventListener('click', spin);
        okBtn.addEventListener('click', closeResult);

        // 点击显示上次结果
        document.getElementById('progress-container').addEventListener('click', ()=>{
            if(!spinning && lastResult != null){
                showResult(lastResult);
            }
        });
    })();

</script>