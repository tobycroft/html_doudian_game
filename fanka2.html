<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>抽卡小游戏</title>

    <style>
        body {
            margin: 0;
            padding: 12px;
            font-family: system-ui, -apple-system;
            background: #f5f6fa;
        }

        .pack-container {
            backdrop-filter: blur(12px);
            background: rgba(255,255,255,0.65);
            border-radius: 16px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .pack-container strong {
            display: block;
            margin-bottom: 8px;
        }

        .pack-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .pack-buttons button {
            font-size: 20px;
            padding: 10px 16px;
            border-radius: 10px;
            border: none;
            background: #ddd;
        }

        .pack-buttons button.active {
            background: #4a90e2;
            color: #fff;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 16px 0;
        }

        .card {
            perspective: 900px;
        }

        .card-inner {
            position: relative;
            width: 100%;
            padding-top: 100%;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }

        .card.open .card-inner {
            transform: rotateY(180deg);
        }

        .face {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 34px;
            border-radius: 14px;
            backface-visibility: hidden;
        }

        .back {
            background: #888;
            color: #fff;
        }

        .front {
            background: #fff;
            border: 2px solid #4a90e2;
            transform: rotateY(180deg);
        }

        .card.selected .back {
            background: #ffd54f;
            color: #000;
        }

        .card.selected .front {
            background: #ffe08a;
        }

        .actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .actions button {
            font-size: 22px;
            padding: 14px;
            border-radius: 16px;
            border: none;
        }

        .confirm {
            background: #4a90e2;
            color: #fff;
        }

        .reset {
            background: #f5b7b1;
        }

        .result-box {
            margin-top: 12px;
            font-size: 18px;
        }
    </style>
</head>

<body>

<div class="pack-container">
    <strong>连包数量</strong>
    <div class="pack-buttons" id="packBtns"></div>
</div>

<div class="grid" id="grid"></div>

<div class="actions">
    <button class="confirm" onclick="confirmOpen()">确定并打开</button>
    <button class="reset" onclick="resetGame()">再抽一次</button>
</div>

<div class="result-box">
    上一次抽取结果：
    <span id="lastResult">无</span>
</div>

<script>
    /* ===== 配置 ===== */
    const API_URL = "https://upload.tuuz.cc:444/v2/doudian/game/fanka";

    /* ===== 状态 ===== */
    let packCount = 1;
    let selected = [];
    let opened = false;
    let lastResult = [];

    /* 默认池 - 新增rand6支持 */
    let NORMAL_POOL = [9,6,5,4,3,3,3,3,3];
    let HIT_CONF = {
        1:0,2:0,3:0.7,4:0.3,5:0.15,6:0.05,
        max:3,
        lock:0
    };

    /* ===== 初始化 ===== */
    initPackButtons();
    fetchRemote();

    /* ===== 包数按钮 ===== */
    function initPackButtons() {
        const box = document.getElementById("packBtns");
        [1,2,3,5].forEach(n => {
            const btn = document.createElement("button");
            btn.textContent = n;
            if (n === 1) btn.classList.add("active");

            btn.onclick = () => {
                packCount = n;
                document.querySelectorAll(".pack-buttons button")
                    .forEach(b => b.classList.remove("active"));
                btn.classList.add("active");
            };
            box.appendChild(btn);
        });
    }

    /* ===== 构建卡片 ===== */
    function buildCards() {
        const grid = document.getElementById("grid");
        grid.innerHTML = "";
        selected = [];
        opened = false;

        NORMAL_POOL.forEach((v, i) => {
            const card = document.createElement("div");
            card.className = "card";
            card.innerHTML = `
            <div class="card-inner">
                <div class="face back">?</div>
                <div class="face front">${v}</div>
            </div>
        `;
            card.onclick = () => toggleSelect(card, i);
            grid.appendChild(card);
        });
    }

    /* ===== 选中逻辑 ===== */
    function toggleSelect(card, idx) {
        if (opened) return;

        if (selected.includes(idx)) {
            selected = selected.filter(i => i !== idx);
            card.classList.remove("selected");
        } else {
            if (selected.length >= packCount) return;
            selected.push(idx);
            card.classList.add("selected");
        }
    }

    /* ===== 权重随机 - 新增rand6支持数字6 ===== */
    function weightedRand() {
        let pool = [];
        Object.entries(HIT_CONF).forEach(([k,v])=>{
            if (+k > 0 && typeof v === "number") {
                for (let i=0;i<v*100;i++) pool.push(+k);
            }
        });
        let r = pool[Math.floor(Math.random()*pool.length)] || 0;
        if (HIT_CONF.lock && r > HIT_CONF.max) return HIT_CONF.max;
        return r;
    }

    /* ===== 数组随机打乱（Fisher-Yates 洗牌算法）===== */
    function shuffleArray(array) {
        const newArray = [...array];
        for (let i = newArray.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
        }
        return newArray;
    }

    /* ===== 确认并打开 ===== */
    function confirmOpen() {
        if (opened) return;
        opened = true;

        // 更新上一次结果显示
        document.getElementById("lastResult").textContent =
            lastResult.length ? lastResult.join(", ") : "无";
        lastResult = [];

        // 获取所有卡片元素
        const cards = document.querySelectorAll(".card");

        // 1. 生成选中卡片的随机结果
        const selectedResults = [];
        selected.forEach(idx => {
            const r = weightedRand();
            selectedResults.push({ idx, value: r });
            lastResult.push(r);
        });

        // 2. 核心逻辑：提取p1-p9的所有数值，保证高优先级数字（p1/p2/p3）必现
        // 2.1 复制原始池数值（保留p1-p9的完整数值列表）
        const originalValues = [...NORMAL_POOL];

        // 2.2 获取未选中卡片的索引列表
        const unselectedIndices = [];
        for (let i = 0; i < NORMAL_POOL.length; i++) {
            if (!selected.includes(i)) {
                unselectedIndices.push(i);
            }
        }

        // 2.3 从原始数值中筛选出与未选中卡片数量匹配的数值（优先保留p1-p9的高优先级值）
        // 确保p1(9)、p2(6)、p3(5)等大数字一定会被保留
        let unselectedValues = [];
        if (originalValues.length >= unselectedIndices.length) {
            // 取前N个（按p1-p9顺序）保证高优先级数值优先
            unselectedValues = originalValues.slice(0, unselectedIndices.length);
        } else {
            // 极端情况：补充默认值（实际不会触发，因为都是9个数值）
            unselectedValues = [...originalValues];
            while (unselectedValues.length < unselectedIndices.length) {
                unselectedValues.push(1);
            }
        }

        // 2.4 随机打乱未选中数值的顺序（位置随机，数值保留）
        const shuffledUnselectedValues = shuffleArray(unselectedValues);

        // 2.5 建立未选中索引和打乱后数值的映射
        const unselectedValueMap = {};
        unselectedIndices.forEach((idx, i) => {
            unselectedValueMap[idx] = shuffledUnselectedValues[i];
        });

        // 3. 为所有卡片设置显示值
        for (let i = 0; i < NORMAL_POOL.length; i++) {
            const card = cards[i];
            // 选中卡片：使用随机生成的值
            if (selected.includes(i)) {
                const result = selectedResults.find(item => item.idx === i);
                card.querySelector(".front").textContent = result.value;
            }
            // 未选中卡片：使用保留高优先级数值且随机打乱后的值
            else {
                card.querySelector(".front").textContent = unselectedValueMap[i];
            }
        }

        // 4. 打开所有卡片
        cards.forEach(card => {
            card.classList.add("open");
        });
    }

    /* ===== 再抽一次 ===== */
    function resetGame() {
        fetchRemote();
    }

    /* ===== 拉取远程池 - 适配rand6 ===== */
    function fetchRemote() {
        fetch(API_URL, {
            method: "POST",
            headers: {"Content-Type":"application/x-www-form-urlencoded"},
            body: "pack=2"
        })
            .then(r=>r.json())
            .then(res=>{
                if (res.code === 0 && res.data.length) {
                    const d = res.data[0];
                    // 更新p1-p9
                    NORMAL_POOL = [d.p1,d.p2,d.p3,d.p4,d.p5,d.p6,d.p7,d.p8,d.p9];
                    // 更新随机配置，新增rand6
                    HIT_CONF = {
                        1:d.rand1 || 0,
                        2:d.rand2 || 0,
                        3:d.rand3 || 0,
                        4:d.rand4 || 0,
                        5:d.rand5 || 0,
                        6:d.rand6 || 0, // 新增rand6支持
                        max:d.max_at || 3,
                        lock:d.lock_at_max || 0
                    };
                }
                buildCards();
            })
            .catch(()=>buildCards());
    }
</script>

</body>
</html>